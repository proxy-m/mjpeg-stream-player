<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	
<script>
	var DEFAULT_FPS = 24,
		DEFAULT_AUTOLOOP = true,
		JPEG_MAGIG_NUMBER = [0xff, 0xd8, 0xff];
		
	var requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame || window.setTimeout;

	function splitMJPEG(mjpegUrl, callback) {
fetch(mjpegUrl)
.then(response => response.body)
.then(rb => {
  const reader = rb.getReader();

  return new ReadableStream({
    start(controller) {
      // The following function handles each data chunk
      function push() {
        // "done" is a Boolean and value a "Uint8Array"
        reader.read().then( ({done, value}) => {
          // If there is no more data to read
          if (done) {
            console.log('done', done);
            controller.close();
            return;
          }
          ///// Get the data and send it to the browser via the controller
          ///controller.enqueue(value);
          // Check chunks by logging to the console
          ///console.log(done, value);
          
          
          
          var array = value, ///new Uint8Array(value),
				startIndex,
				jpegs = [];
			///alert(array.length);

			for (var i=0, ii=array.length; i<ii; ++i) {
				if (array[i] === JPEG_MAGIG_NUMBER[0] && array[i+1] === JPEG_MAGIG_NUMBER[1] && array[i+2] === JPEG_MAGIG_NUMBER[2]) {
					if (i>0 && typeof startIndex === 'number') {
						///alert(array.subarray(startIndex, i));
						///alert(String.fromCharCode.apply(null, array.subarray(startIndex, i)));
						jpegs.push(new Blob([array.subarray(startIndex, i)], {type: 'image/jpeg'}));
					}
					startIndex = i;
				}
			}

			callback(jpegs);
          
          
          push();
        })
      }

      push();
    }
});
});	
}

	function playMJPEGInternal(wrapperElement, mjpegUrl, fps, autoloop) {
		fps = (typeof fps === 'number') ? fps : DEFAULT_FPS;
		autoloop = (typeof autoloop === 'boolean') ? autoloop : DEFAULT_AUTOLOOP;

		var playbackFinished = false,
			imageElement = document.createElement('img'),
			jpegUrl;

		imageElement.setAttribute('style', 'width:100%;');
		wrapperElement.appendChild(imageElement);

		splitMJPEG(mjpegUrl, function(jpegFiles) {
			if (jpegFiles.length > 0) {
				var nextFrameIndex = 0;

				function showNextFrame() {
					if (imageElement) {
						if (jpegUrl) {
							URL.revokeObjectURL(jpegUrl);
						}
						if (nextFrameIndex >= jpegFiles.length) {
							return;
						}
						jpegUrl = URL.createObjectURL(jpegFiles[nextFrameIndex++]);
						
						imageElement.onerror = function() {
							setTimeout(function() {
								requestAnimationFrame(showNextFrame);
							}, 1000/fps);
						};

						imageElement.onload = function() {
							
							if (imageElement) {
								if (autoloop || nextFrameIndex < jpegFiles.length) {
									nextFrameIndex = (nextFrameIndex === jpegFiles.length) ? 0 : nextFrameIndex;
									setTimeout(function() {
										requestAnimationFrame(showNextFrame);
									}, 1000/fps);
								}
							}
						};
						
						imageElement.setAttribute('src', jpegUrl);
					}
				};

				setTimeout(function() {
					requestAnimationFrame(showNextFrame);
				}, 1000/fps);
			}
		});

		return {
			finish: function() {
				if (imageElement) {
					imageElement.src = '';
					wrapperElement.removeChild(imageElement);
					imageElement = undefined;
				}
			}
		};	
	};


</script>
</head>
<body>
	<div id="mjpeg_stream_player_wrapper">
	</div>
	
	<script>
		var mjpegUrl = './data/grill-mjpeg.mov';
		var fps = 55;
		var autoloop = false; // not supported now
		playMJPEGInternal(document.getElementById('mjpeg_stream_player_wrapper'), mjpegUrl, fps, autoloop);
	</script>
</body>
</html>
